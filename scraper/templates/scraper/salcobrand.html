{% extends 'scraper/base.html' %}

{% load static %}

{% block title %}
Salcobrand
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Extracción de Datos - Salcobrand</h2>
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="form-group">
                <label for="categoria-select">Seleccione Categoría</label>
                <select id="categoria-select" class="form-control">
                    <option value="">Seleccione una categoría</option>
                    <option value="medicamentos">Medicamentos</option>
                    <option value="vitaminas_suplementos">Vitaminas y suplementos</option>
                </select>
            </div>
            <button type="button" onclick="startExtraction('salcobrand')" class="btn btn-primary">Iniciar Extracción</button>
            <button type="button" onclick="cancelExtraction('salcobrand')" class="btn btn-warning">Cancelar Extracción</button>
        </div>
    </div>

    <h3>Resultados de la Extracción</h3>

    <!-- Contenedor para la búsqueda y el spinner -->
    <div class="card">
        <div class="card-body">
            <div class="mb-3">
                <input type="text" id="search-input" class="form-control" placeholder="Buscar por SKU...">
            </div>

            <!-- Contenedor de información de extracción y spinner -->
            <div class="d-flex flex-column align-items-center mb-3">
                <!-- Spinner de carga -->
                <div id="loadingSpinner" class="custom-hidden mb-2">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <div id="extraction-info" class="d-flex justify-content-center">
                        <p class="mb-0 mr-4">Total SKU extraído: <span id="total-sku">0</span></p>
                        <p class="mb-0 mr-4">Ultima pagina extraccion: <span id="current-page">1</span></p>
                        <p class="mb-0">Último producto extraído: <span id="last-product">N/A</span></p>
                    </div>
                </div>
            </div>

            <!-- Tabla de resultados -->
            <div class="table-responsive">
                <table class="table table-striped" id="results-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Primer Nombre</th>
                            <th>Segundo Nombre</th>
                            <th>Precio Farmacia</th>
                            <th>Precio Internet</th>
                            <th>SBPay</th>
                            <th>URL Producto</th>
                            <th>Imagen</th>
                        </tr>
                    </thead>
                    <tbody id="extraction-results">
                        <!-- Resultados de extracción se mostrarán aquí -->
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <nav>
                <ul class="pagination justify-content-center" id="pagination">
                    <!-- Botones de paginación se generarán dinámicamente aquí -->
                </ul>
            </nav>
        </div>
    </div>
</div>

<!-- Modal de descarga -->
<div class="modal" tabindex="-1" role="dialog" id="downloadModal" style="display: none;">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Extracción Completada</h5>
        <button type="button" class="close" onclick="hideDownloadModal()" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>La extracción de datos se ha completado. ¿Desea guardar el archivo?</p>
        <a id="downloadLink" href="#" class="btn btn-success">Descargar archivo</a>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideDownloadModal()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
let intervalId;
let allData = [];
const itemsPerPage = 24;
let currentPage = 1;
const maxVisiblePages = 3;

function startExtraction(farmacia) {
    const categoria = document.getElementById('categoria-select').value;

    if (!categoria) {
        alert('Por favor, seleccione una categoría.');
        return;
    }

    showSpinner();

    fetch(`/iniciar_extraccion/?farmacia=${farmacia}&categoria=${categoria}`)
        .then(response => response.json())
        .then(data => {
            if (data.status) {
                alert(data.status);
                intervalId = setInterval(() => fetchScrapingData(farmacia), 2000);
            } else {
                alert(data.error);
                hideSpinner();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideSpinner();
        });
}

function fetchScrapingData(farmacia) {
    fetch(`/get_scraping_data/?farmacia=${farmacia}`)
        .then(response => response.json())
        .then(data => {
            if (data.extraction_complete) {
                clearInterval(intervalId);
                showDownloadModal(data.file_url);
                hideSpinner();
            } else {
                allData = data.data;
                updateTableData();
                setupPagination();
                updateExtractionInfo(data.current_page);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            hideSpinner();
        });
}

function setupPagination() {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';

    const pageCount = Math.ceil(allData.length / itemsPerPage);
    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(pageCount, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    const prevLi = document.createElement('li');
    prevLi.classList.add('page-item');
    if (currentPage === 1) prevLi.classList.add('disabled');
    prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
    prevLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage > 1) {
            currentPage--;
            updateTableData();
            setupPagination();
        }
    });
    pagination.appendChild(prevLi);

    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.classList.add('page-item');
        if (i === currentPage) li.classList.add('active');
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage = i;
            updateTableData();
            setupPagination();
        });
        pagination.appendChild(li);
    }

    const nextLi = document.createElement('li');
    nextLi.classList.add('page-item');
    if (currentPage === pageCount) nextLi.classList.add('disabled');
    nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
    nextLi.addEventListener('click', (e) => {
        e.preventDefault();
        if (currentPage < pageCount) {
            currentPage++;
            updateTableData();
            setupPagination();
        }
    });
    pagination.appendChild(nextLi);
}

function updateExtractionInfo(currentPageFromSite) {
    document.getElementById('total-sku').textContent = allData.length;
    document.getElementById('current-page').textContent = currentPageFromSite;
    if (allData.length > 0) {
        document.getElementById('last-product').textContent = allData[allData.length - 1].Primer_nombre;
    } else {
        document.getElementById('last-product').textContent = 'N/A';
    }
}

function cancelExtraction(farmacia) {
    fetch(`/cancel_extraction/?farmacia=${farmacia}`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = ''; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            clearInterval(intervalId);
            hideSpinner();
        })
        .catch(error => {
            console.error('Error al cancelar la extracción:', error);
            hideSpinner();
        });
}

function showDownloadModal(fileUrl) {
    const downloadLink = document.getElementById('downloadLink');
    downloadLink.href = `/get_temporary_file/?file_name=${encodeURIComponent(fileUrl)}`;
    downloadLink.onclick = function () {
        fetch(downloadLink.href)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = ''; 
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            })
            .catch(error => console.error('Error al descargar el archivo:', error));
        return false; 
    };
    document.getElementById('downloadModal').style.display = 'block';
}

function hideDownloadModal() {
    document.getElementById('downloadModal').style.display = 'none';
}

function updateTableData() {
    const resultsTable = document.getElementById('extraction-results');
    resultsTable.innerHTML = ''; 
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageData = allData.slice(start, end);

    pageData.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.SKU}</td>
            <td>${item.Primer_nombre}</td>
            <td>${item.Segundo_nombre}</td>
            <td>${item.Precio_Farmacia}</td>
            <td>${item.Precio_Internet}</td>
            <td>${item.SBPay}</td>
            <td><a href="${item.URL_Producto}" target="_blank">Ver Producto</a></td>
            <td><img src="${item.URL_Imagen}" alt="Imagen del Producto" style="width: 100px; height: auto;"></td>
        `;
        resultsTable.appendChild(row);
    });
}

document.getElementById('search-input').addEventListener('input', function () {
    const query = this.value.toLowerCase();
    const filteredData = allData.filter(item =>
        item.SKU.toLowerCase().includes(query)
    );
    currentPage = 1;
    allData = filteredData;
    updateTableData();
    setupPagination();
});

function showSpinner() {
    document.getElementById('loadingSpinner').classList.remove('custom-hidden');
}

function hideSpinner() {
    document.getElementById('loadingSpinner').classList.add('custom-hidden');
}

</script>

{% endblock %}
