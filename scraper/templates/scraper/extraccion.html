{% extends 'scraper/base.html' %}

{% block title %}Extracción de Datos{% endblock %}

{% block content %}
<h2>Extracción de Datos</h2>
<form id="extraccion-form">
    <div class="form-group">
        <label for="farmacia-select">Seleccione Farmacia</label>
        <select id="farmacia-select" class="form-control" onchange="loadCategories()">
            <option value="">Seleccione una opción</option>
            <option value="salcobrand">Salcobrand</option>
            <option value="profar">Profar</option>
        </select>
    </div>
    <div class="form-group">
        <label for="categoria-select">Seleccione Categoría</label>
        <select id="categoria-select" class="form-control">
            <option value="">Seleccione una categoría</option>
        </select>
    </div>
    <button type="button" onclick="startExtraction()" class="btn btn-primary">Iniciar Extracción</button>
</form>

<h3>Resultados de la Extracción</h3>
<table class="table table-striped" id="results-table">
    <thead>
        <tr id="table-headers">
            <!-- Encabezados de tabla dinámicos -->
        </tr>
    </thead>
    <tbody id="extraction-results">
        <!-- Resultados de extracción se mostrarán aquí -->
    </tbody>
</table>

<script>
    function loadCategories() {
        const farmacia = document.getElementById('farmacia-select').value;
        const categoriaSelect = document.getElementById('categoria-select');
        categoriaSelect.innerHTML = ''; // Limpiar categorías anteriores

        if (farmacia === 'salcobrand') {
            categoriaSelect.innerHTML = `
                <option value="medicamentos">Medicamentos</option>
                <option value="vitaminas">Vitaminas</option>
            `;
        } else if (farmacia === 'profar') {
            categoriaSelect.innerHTML = `
                <option value="medicamentos">Medicamentos</option>
                <option value="vitaminas">Vitaminas</option>
            `;
        }
    }

    function startExtraction() {
        const farmacia = document.getElementById('farmacia-select').value;
        const categoria = document.getElementById('categoria-select').value;

        if (!farmacia || !categoria) {
            alert('Por favor, seleccione una farmacia y una categoría.');
            return;
        }

        fetch(`/iniciar_extraccion/?farmacia=${farmacia}&categoria=${categoria}`)
            .then(response => response.json())
            .then(data => {
                if (data.status) {
                    alert(data.status);
                    setInterval(() => fetchScrapingData(farmacia), 2000); // Actualiza cada 2 segundos
                } else {
                    alert(data.error);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function fetchScrapingData(farmacia) {
        fetch(`/get_scraping_data/?farmacia=${farmacia}`)
            .then(response => response.json())
            .then(data => {
                updateTableHeaders(data.columns);
                updateTableData(data.data);
            })
            .catch(error => console.error('Error:', error));
    }

    function updateTableHeaders(columns) {
        const tableHeaders = document.getElementById('table-headers');
        tableHeaders.innerHTML = ''; // Clear existing headers
        columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = column;
            tableHeaders.appendChild(th);
        });
    }

    function updateTableData(data) {
        const resultsTable = document.getElementById('extraction-results');
        resultsTable.innerHTML = ''; // Limpiar resultados anteriores
        data.forEach(item => {
            const row = document.createElement('tr');
            Object.values(item).forEach(text => {
                const cell = document.createElement('td');
                cell.textContent = text;
                row.appendChild(cell);
            });
            resultsTable.appendChild(row);
        });
    }
</script>
{% endblock %}
